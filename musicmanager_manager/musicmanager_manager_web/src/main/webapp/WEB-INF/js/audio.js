/**
 * Created by Administrator on 2017/7/30.
 */

var music=[
    {"no":"01","name":"七月上","singer":"Jam","src":"audioFile/1.mp3","zhuanji":"七月上","length":"03:10","size":"2.9MB","image":"images/1.png","lyric":"[00:00]作曲 : Jam [00:01]作词 : Jam[00:13]我化尘埃飞扬，追寻赤裸逆翔[00:21]奔去七月刑场，时间烧灼滚烫[00:29]回忆撕毁臆想，路上行走匆忙[00:37]难能可贵世上，散播留香磁场[00:49]我欲乘风破浪，踏遍黄沙海洋[00:53]与其误会一场，也要不负勇往[00:58]我愿你是个谎，从未出现南墙[01:02]笑是神的伪装，笑是强忍的伤[01:07]就让我走向你，走向你的床[01:11]就让我看见你，看见你的伤[01:15]我想你就站在，站在大漠边疆[01:20]我想你就站在，站在七月上[01:30]&nbsp[01:38]我化尘埃飞扬，追寻赤裸逆翔[01:46]奔去七月刑场，时间烧灼滚烫[01:54]回忆撕毁臆想，路上行走匆忙[02:03]难能可贵世上，散播留香磁场[02:10]&nbsp[02:15]我欲乘风破浪，踏遍黄沙海洋[02:18]与其误会一场，也要不负勇往[02:23]我愿你是个谎，从未出现南墙[02:28]笑是神的伪装，笑是强忍的伤[02:32]就让我走向你，走向你的床[02:36]就让我看见你，看见你的伤[02:41]我想你就站在，站在大漠边疆[02:45]我想你就站在，站在七月上[03:10]歌词贡献者：慢梦"},
    {"no":"02","name":"奇妙能力歌","singer":"陈粒","src":"audioFile/2.mp3","zhuanji":"热门华语","length":"04:13","size":"9.7MB","image":"images/2.png","lyric":"[00:19]我看过沙漠下暴雨[00:24]看过大海亲吻鲨鱼[00:28]看过黄昏追逐黎明[00:31]没看过你[00:36]我知道美丽会老去[00:41]生命之外还有生命[00:45]我知道风里有诗句[00:49]不知道你[00:54]我听过荒芜变成热闹[00:59]听过尘埃掩埋城堡[01:03]听过天空拒绝飞鸟[01:06]没听过你[01:12]我明白眼前都是气泡[01:16]安静的才是苦口良药[01:20]明白什么才让我骄傲[01:24]不明白你[01:29]我拒绝更好更圆的月亮[01:34]拒绝未知的疯狂[01:38]拒绝声色的张扬[01:42]不拒绝你[01:47]我变成荒凉的景象[01:52]变成无所谓的模样[01:56]变成透明的高墙[01:59]没能变成你[02:08]&nbsp[02:39]我听过空境的回忆[02:44]雨水浇绿孤山岭[02:48]听过被诅咒的秘密[02:52]没听过你[02:56]我抓住散落的欲望[03:01]缱绻的馥郁让我紧张[03:05]我抓住时间的假想[03:09]没抓住你[03:14]我包容六月清泉结冰[03:18]包容暮老的生命[03:22]包容世界的迟疑[03:26]没包容你[03:32]我忘了置身濒绝孤岛[03:36]忘了眼泪不过是笑料[03:40]忘了百年无声口号[03:44]没能忘记你[03:49]我想要更好更圆的月亮[03:53]想要未知的疯狂[03:58]想要声色的张扬[04:01]我想要你"},
    {"no":"03","name":"好久不见","singer":"陈奕迅","src":"audioFile/3.mp3","zhuanji":"跨世纪国语精选","length":"04:10","size":"9.6MB","image":"images/3.png","lyric":"[00:00]作曲 : 陈小霞[00:01]作词 : 林夕[00:15]我来到你的城市[00:22]走过你来时的路[00:28]想象着没我的日子[00:34]你是怎样的孤独[00:41]拿着你给的照片[00:48]熟悉的那一条街[00:54]只是没了你的画面[01:00]我们回不到那天[01:07]你会不会忽然的出现[01:15]在街角的咖啡店[01:21]我会带着笑脸挥手寒暄[01:27]和你坐着聊聊天[01:33]我多么想和你见一面[01:40]看看你最近改变[01:47]不再去说从前只是寒暄[01:53]对你说一句只是说一句[02:02]好久不见[02:06]&nbsp[02:21]拿着你给的照片[02:27]熟悉的那一条街[02:34]只是没了你的画面[02:39]我们回不到那天[02:45]你会不会忽然的出现[02:52]在街角的咖啡店[02:58]我会带着笑脸挥手寒暄[03:04]和你坐着聊聊天[03:11]我多么想和你见一面[03:18]看看你最近改变[03:24]不再去说从前只是寒暄[03:30]对你说一句只是说一句[03:40]好久不见"},
    {"no":"04","name":"年少有你","singer":"李易峰","src":"audioFile/4.mp3","zhuanji":"栀子花开电影原声带","length":"04:36","size":"10.6MB","image":"images/4.png","lyric":"[00:00]作曲 : 好妹妹乐队[00:01]作词 : 好妹妹乐队[00:28]时常会想起那年斑驳的课桌[00:36]发呆时总望着你的轮廓[00:42]你也许不知道那时小小的我[00:49]年少的秘密藏在心中的角落[00:55]&nbsp[00:57]路口等着你有我和我的单车[01:04]微凉的傍晚有你陪着我[01:10]晚霞再美不及你眼眸的颜色[01:17]没有说再见 离别总是沉默[01:23]&nbsp[01:28]是否 你也会偶尔想起我[01:34]像我时常也把往事轻轻诉说[01:41]我们在春风秋雨里无话不说[01:47]却在春去秋来中失去了联络[01:53]&nbsp[01:54]是否 你也会偶尔想起我[02:01]还是你在过着与我无关的生活[02:09]幸好彼此的青春都没有错过[02:15]我的年少有你 你的青春有我[02:21]&nbsp[02:46]路口等着你有我和我的单车[02:53]微凉的傍晚有你陪着我[03:00]晚霞再美不及你眼眸的颜色[03:06]没有说再见 离别总是沉默[03:12]&nbsp[03:13]是否 你也会偶尔想起我[03:20]像我时常也把心事轻轻诉说[03:28]我们在春风秋雨里无话不说[03:34]却在春去秋来中失去了联络[03:40]&nbsp[03:41]是否 你也会偶尔想起我[03:47]还是你在过着与我无关的生活[03:54]幸好彼此的青春都没有错过[04:02]我的年少有你 你的青春有我[04:08]我的年少有你 你的青春有我"}
];
var oMusic=eval(music);
var oListSong=document.getElementsByClassName("listSong")[0];
var oSongs=oListSong.getElementsByTagName("div");

var oPlay=document.getElementsByClassName("play")[0];
var oCurrent=document.getElementsByClassName("current_time")[0];
var oTotal=document.getElementsByClassName("total_time")[0];
var oAudio=document.getElementById("audio");
var oProgress=document.getElementsByClassName("range")[0];
var oMaxProgress=document.getElementsByClassName("progress")[0];
var oProgress_circle=document.getElementsByClassName("circle")[0];
var oVolume=document.getElementsByClassName("range")[1];
var oVolume_circle=document.getElementsByClassName("circle")[1];
var oVolumeIcon=document.getElementsByClassName("volume")[0];
var oMaxVolume=document.getElementsByClassName("volume_range")[0];
var clickNum=0;
var clickNum1=0;
var clickNum3=0;
var oBofangModel=document.getElementsByClassName("bofangModel")[0];
var oMusic_image=document.getElementsByClassName("music_image")[0];
var oImg=oMusic_image.getElementsByTagName("img")[0];
var oFangda=oMusic_image.getElementsByClassName("icon-bofangqi_quanpingfangda")[0];
var oSuoxiao=document.getElementsByClassName("icon-bofangqi_quanpingsuoxiao")[0];
var oName=oMusic_image.getElementsByTagName("span")[0];
var oSinger=oMusic_image.getElementsByTagName("span")[1];
var oNum=document.getElementsByClassName("num")[0];
var oNo=document.getElementsByClassName("no");

var oNext=document.getElementsByClassName("icon-kuaijin")[0];
var oPre=document.getElementsByClassName("icon-kuaitui")[0];
//列表部分
var oMusicList=document.getElementsByClassName("musicList")[0];
//正在播放的歌曲部分
var oPlaying_song=document.getElementsByClassName("playing_song")[0];
var oNeedle=document.getElementById("needle");
var oDisk=document.getElementById("disk");
var oBg=document.getElementById("bg");
var oAlbum=document.getElementsByClassName("album")[0];
var oH1=document.getElementsByTagName("h1")[0];
var oZhuanji1=document.getElementById("zhuanji");
var oSinger1=document.getElementById("singer");
var oLyrics=document.getElementsByClassName("lyrics");

//喜欢部分
var oXin=document.getElementsByClassName("xin")[0];
var clickNum2=0;

var oBottom_icons=document.getElementsByClassName("bottom_icon")[0].getElementsByTagName("span");
//加载歌曲
window.onload=function () {
    for(var i=0;i<oMusic.length;i++){        //在这里获取数据库的总数据个数oMusic.length
        //设置列表
        oListSong.innerHTML+="<div><span class='no'>"+oMusic[i].no+"</span><span class='name'>"+oMusic[i].name+"</span><span class='singer'>"+oMusic[i].singer+"</span><span class='zhuanji'>"+oMusic[i].zhuanji+"</span><span class='length'>"+oMusic[i].length+"</span><span class='size'>"+oMusic[i].size+"</span></div>";
    }
    oNum.innerHTML=oMusic.length+"首歌曲";
    oAudio.addEventListener("canplay", function() {
        oTotal.innerHTML=format(oAudio.duration);       //获取总时间
    });

    //获取上一次播放的音乐的信息
    if(localStorage.getItem("index")!=""&&localStorage.getItem("index")!=null&&localStorage.getItem("index")!="undefined"){
        setInfo();
    } else{
        localStorage.setItem("index",0);
        setInfo();
    }
    //获取上一次播放的声音的信息
    if(localStorage.getItem("volume")!=""&&localStorage.getItem("volume")!=null){
        oVolume.style.width=localStorage.getItem("volume")+"px";         // 音量0-1
        oVolume_circle.style.left=oVolume.style.width;
    } else{
        oVolume.style.width="100px";         // 音量0-1
        oVolume_circle.style.left=oVolume.style.width;
        localStorage.setItem("volume",100);
    }
    //点击自动播放
    for(var i=0;i<oSongs.length;i++){
        oSongs[i].index=i;
        oSongs[i].onclick=function () {
            // 设置当前点击歌曲
            playSong(this.index);
        }
    }

    //通过localStorage中的index设置歌曲信息
    function setInfo() {
        var m=parseInt(localStorage.getItem("index"));
        oAudio.setAttribute("src",oMusic[m].src);
        console.log(oAudio.src);
        if(oMusic[m].image!=""){
            oImg.setAttribute("src",oMusic[m].image);
            oAlbum.setAttribute("src",oMusic[m].image);
            oBg.style.background="url('"+oMusic[m].image+"') no-repeat";
            oBg.style.backgroundSize="cover";       //设置背景图片
        }
        oName.innerHTML=oMusic[m].name;
        oSinger.innerHTML=oMusic[m].singer;
        oH1.innerHTML=oMusic[m].name;
        oZhuanji1.innerHTML=oMusic[m].zhuanji;
        oSinger1.innerHTML=oMusic[m].singer;
        for(var j=0;j<oMusic.length;j++){
            if(j!=m)
                oNo[j+1].innerHTML=oMusic[j].no;
        }
        oNo[m+1].innerHTML="<span class='iconfont icon-yinfu' style='color: lightcoral'/>";
        if(oMusic[m].lyric!="")
            parse(oMusic[m].lyric);     //调用加载歌词函数
        else{
            alert(11);
            for(var i=0;i<oLyrics.length;i++){
                oLyrics[i].innerHTML="&nbsp";
            }
            oLyrics[0].innerHTML="暂无歌词";
        }

        //是否喜欢
        if(localStorage.getItem("like")){
            oXin.innerHTML="<i class='iconfont icon-xin1' title='取消喜欢' style='cursor: pointer;color: lightcoral'></i>";
            oBottom_icons[0].innerHTML="<i class='iconfont icon-xin1' title='取消喜欢' style='cursor: pointer;color: lightcoral'></i>喜欢";
            clickNum2=1;
        }
    }

    //播放当前歌曲
    function playSong(index) {
        localStorage.setItem("index",index);
        setInfo();
        oAudio.play();
        oPlay.innerHTML="<i class='iconfont icon-bofang' title='暂停'></i>";
        clickNum=1;
        oNeedle.style.animation="rotate-needle-resume 0.5s 1 normal linear forwards;";
        oDisk.animationPlayState="running";
        setInterval(setProgress,1000);
    }

    //播放与暂停按钮的设置
    oPlay.onclick=function () {
        if(clickNum==0){
            oAudio.play();
            setInterval(setProgress,1000);
            oPlay.innerHTML="<i class='iconfont icon-bofang' title='暂停'></i>";
            clickNum=1;
            oNeedle.style.transform="rotate(0deg)";
            oDisk.style.animationPlayState="running";
        }
        else{
            oAudio.pause();
            oPlay.innerHTML="<i class='iconfont icon-zanting' title='播放'></i>";
            clickNum=0;
            oNeedle.style.transform="rotate(-25deg)";
            oDisk.style.animationPlayState="paused";
        }
    }

    //下一首按钮的点击
    oNext.onclick=function () {
        var next=(parseInt(localStorage.getItem("index"))+1)%oMusic.length;
        if(clickNum==0){
            localStorage.setItem("index",next);
            setInfo();
        } else{
            playSong(next);
        }
    }
    //上一首按钮的点击事件
    oPre.onclick=function () {
        var pre=oMusic.length-1;
        if(parseInt(localStorage.getItem("index"))!=0)
            pre=(parseInt(localStorage.getItem("index"))-1)%oMusic.length;
        if(clickNum==0){        //未播放只设置信息
            localStorage.setItem("index",pre);
            setInfo();
        } else{
            playSong(pre);
        }
    }

    //设置进度的自动移动
    function setProgress() {
        oCurrent.innerHTML=format(oAudio.currentTime);  //当前时间
        oProgress.style.width=(oAudio.currentTime)/(oAudio.duration)*780+"px";
        oProgress_circle.style.left=oProgress.style.width;
    }

    //可以点击轨道改变进度
    oMaxProgress.onmousedown=function (ev) {
        changeProgress(ev);
    }
    //鼠标拖动小圆改变进度
    oProgress_circle.onmousedown=function (ev) {
        document.onmousemove=function (ev) {
            changeProgress(ev);
        }
        document.onmouseup = function () {      //当鼠标松开后关闭移动事件和自身事件
            document.onmousemove = null;
            document.onmouseup = null;
        }
        return false;
    }
    function changeProgress(ev){
        var ev=ev||event;
        var l = ev.clientX - 270;          //获取圆距左端的距离
        if(l<0){
            l=0;
        }
        else if (l > 780) {
            l = 780;
        }
        localStorage.setItem("progress",l);
        oProgress_circle.style.left=l+"px";
        oProgress.style.width=l+"px";
        oAudio.currentTime=(l/780)*oAudio.duration;
        oCurrent.innerHTML=format(oAudio.currentTime);  //当前时间
    }

    //时间的设置,点击轨道
    oMaxVolume.onmousedown=function (ev) {
        changeVolume(ev);
    }
    //拖动小圆
    oVolume_circle.onmousedown=function (ev) {
        document.onmousemove=function (ev) {
            changeVolume(ev);
        }
        document.onmouseup = function () {      //当鼠标松开后关闭移动事件和自身事件
            document.onmousemove = null;
            document.onmouseup = null;
        }
        return false;
    }
    function changeVolume(ev) {
        var ev=ev||event;
        var l = ev.clientX - 1160;          //获取圆距foot左端的距离
        if(l<0){
            l=0;
        }
        else if (l > 100) {
            l = 100;
        }
        oVolume_circle.style.left=l+"px";
        oVolume.style.width=l+"px";
        oAudio.volume=l/100;
        localStorage.setItem("volume",l);
        if(l==0){
            oVolumeIcon.innerHTML="<span class='iconfont icon-jingyin' title='恢复音量'></span>";
            clickNum1=1;
        }
        else{
            oVolumeIcon.innerHTML="<span class='iconfont icon-shengyin' title='静音'></span>";
            clickNum1=0;
        }
    }

    //静音与恢复音量的设置
    oVolumeIcon.onclick=function () {
        if(clickNum1==0){
            oVolumeIcon.innerHTML="<span class='iconfont icon-jingyin' title='恢复音量'></span>";
            oVolume_circle.style.left="0px";
            oVolume.style.width="0px";
            oAudio.volume=0;
            clickNum1=1;
        }
        else{
            oVolumeIcon.innerHTML="<span class='iconfont icon-shengyin' title='静音'></span>";
            var l=localStorage.getItem("volume");
            if(l==0)
                l+=1;
            oVolume_circle.style.left=l+"px";
            oVolume.style.width=l+"px";
            oAudio.volume=l/100;
            clickNum1=0;
        }
    }

    //时间的格式化
    function format(t) {
        var m=Math.floor(t/60);
        var s=Math.floor(t%60);
        if(m<=9)
            m="0"+m;
        if(s<=9)
            s="0"+s;
        return m+":"+s;
    }

    //刚加载，clickNum3=0，不触发点击事件
    if(clickNum3==0){
        oAudio.loop=false;
        oAudio.addEventListener("ended", suiji, false);     //监听函数不能加括号
    }
    //播放模式的切换
    oBofangModel.onclick=function () {
        if(clickNum3==0){
            oBofangModel.innerHTML="<span class='iconfont icon-liebiaoxunhuan' title='列表循环'></span>";
            clickNum3=1;
            oAudio.loop=false;
            // oAudio.removeEventListener("ended",function () {},false);       //匿名取消事件无效
            oAudio.removeEventListener("ended",suiji,false);
            oAudio.addEventListener("ended", liebiao, false);
        }
        else if(clickNum3==1){
            oBofangModel.innerHTML="<span class='iconfont icon-danquxunhuan1' title='单曲循环'></span>";
            clickNum3=2;
            oAudio.loop=true;
        }
        else if(clickNum3==2){
            oBofangModel.innerHTML="<span class='iconfont icon-suiji' title='随机播放'></span>";
            clickNum3=0;
            if(oAudio!=null){
                oAudio.loop=false;
                oAudio.removeEventListener("ended",liebiao,false);
                oAudio.addEventListener("ended", suiji, false);
            }
        }
    }
    //列表循环，触发下一首的点击事件
    function liebiao(){
        oNext.onclick();
    }
    //产生随机数，自动播放
    function suiji() {
        var m=Math.floor(Math.random()*oMusic.length);//产生随机数，范围为0到oMusic.length-1,
        playSong(m);
    }

    //全屏放大
    oFangda.onmouseover=function () {
        oImg.style.opacity="0.5";
        oFangda.style.opacity=1;
    }
    oFangda.onmouseout=function () {
        oImg.style.opacity=1;
        oFangda.style.opacity=0;
    }
    oFangda.onclick=function () {
        oMusicList.style.opacity=0;
        oMusicList.style.height=0;
        oPlaying_song.style.opacity=1;
        oMusicList.style.zIndex="-2";
        oPlaying_song.style.zIndex="1";
    }
    oSuoxiao.onclick=function () {
        oMusicList.style.opacity=1;
        oMusicList.style.height="100%";
        oPlaying_song.style.opacity=0;
        oMusicList.style.zIndex="1";
        oPlaying_song.style.zIndex="-2";
    }



}

//加载歌词
var times=new Array();
var lyrics=new Array();
function parse(lrc) {
    str=lrc.split("[");
    for(var i=1;i<str.length;i++){
        var time=str[i].split("]")[0];      //前面的时间
        var lyric=str[i].split("]")[1];     //时间后面的歌词
        var m=time.split(":")[0];
        var s=time.split(":")[1];
        var sec=parseInt(m)*60+parseInt(s);
        times[i-1]=parseInt(sec);
        lyrics[i-1]=lyric;
    }
    setInterval(updateLyric,1000);
}
//更新当前歌词
function updateLyric() {
    var i=getcurrent();
    for(var j=-4;j<=4;j++){
        if(lyrics[i+j]){
            oLyrics[j+4].innerHTML=lyrics[i+j];
        } else
            oLyrics[j+4].innerHTML="&nbsp";
    }
    oLyrics[4].style.color="white";     //当前的句时白色
}
//将歌曲实际播放的时间，和我们自己的歌词的时间，进行比较，算出现在应该显示的歌词的下标
function getcurrent()
{
    var i=0;
    for(i=0;i<times.length;i++)
    {
        //数和undefined比较，undefined要大些。大于等于的时候应该唱的是上一句
        if(times[i]>=oAudio.currentTime){
            break;
        }
    }
    return i-1;     //返回上一句
}

//喜欢
oXin.onclick=function () {
    if(clickNum2==0){
        oXin.innerHTML="<i class='iconfont icon-xin1' title='取消喜欢' style='cursor: pointer;color: lightcoral'></i>"
        oBottom_icons[0].innerHTML="<i class='iconfont icon-xin1' title='取消喜欢' style='cursor: pointer;color: lightcoral'></i>喜欢";
        alert("已收藏到我喜欢的音乐");
        clickNum2=1;
        localStorage.setItem("like",1);
    }
    else{
        if(confirm("确定将选中歌曲从我喜欢的音乐中删除？")){
            oXin.innerHTML="<i class='iconfont icon-xin' title='喜欢' style='cursor: pointer;'></i>"
            oBottom_icons[0].innerHTML="<i class='iconfont icon-xin' title='喜欢' style='cursor: pointer;'></i>喜欢";
            clickNum2=0;
            localStorage.setItem("like",0);
        }
    }
}

//详细信息页
oBottom_icons[0].onclick=function () {
    if(clickNum2==0){
        this.innerHTML="<i class='iconfont icon-xin1' title='取消喜欢' style='cursor: pointer;color: lightcoral'></i>喜欢";
        oXin.innerHTML="<i class='iconfont icon-xin1' title='取消喜欢' style='cursor: pointer;color: lightcoral'></i>"
        alert("已收藏到我喜欢的音乐");
        clickNum2=1;
        localStorage.setItem("like",1);
    }
    else{
        if(confirm("确定将选中歌曲从我喜欢的音乐中删除？")){
            this.innerHTML="<i class='iconfont icon-xin' title='喜欢' style='cursor: pointer;'></i>喜欢";
            oXin.innerHTML="<i class='iconfont icon-xin' title='喜欢' style='cursor: pointer;'></i>"
            clickNum2=0;
            localStorage.setItem("like",0);
        }
    }
}














